#!/bin/sh

set -e

export GOOS=noos

case "$GOTARGET" in
stm32*|nrf5*)
	export GOARCH=thumb
	if [ "$GOARM" ]; then
		export GOARM
	fi
	;;
k210)
	export GOARCH=riscv64
	;;
*)
	echo "unknown GOTARGET: '$GOTARGET'"
	exit 1
	;;
esac

if [ -z "$ISRNAMES" ]; then
	case "$GOTARGET" in
	stm32*)
		ISRNAMES=github.com/embeddedgo/stm32/hal/irq
		;;
	nrf5*)
		ISRNAMES=github.com/embeddedgo/nrf5/hal/irq
		;;
	k210)
		ISRNAMES=github.com/embeddedgo/kendryte/hal/irq
		;;
	esac
	ISRNAMES=$(go list -tags $GOTARGET -f '{{.Dir}}' $ISRNAMES)
fi

if [ "$ISRNAMES" != 'no' ]; then
{
	echo '// DO NOT EDIT THIS FILE. GENERATED BY build.sh.'
	echo
	echo 'package main'
	echo
	echo 'import _ "unsafe"'
	echo
	while read name a1 a2 a3 rest; do
		if [ "$a1" = '=' ]; then
			echo "//go:linkname ${name}_Handler IRQ${a2}_Handler"
		elif [ "$a2" = '=' ]; then
			echo "//go:linkname ${name}_Handler IRQ${a3}_Handler"
		fi
	done <"$ISRNAMES/$GOTARGET.go"
} >zisrnames.go
fi

name=$(basename $(pwd))

ldflags="-M $GOMEM"
if [ -n "$GOTEXT" ]; then
	ldflags="$ldflags -T $GOTEXT"
fi

if [ -z "$GOBIN" ]; then
	GOBIN=go
fi

if [ -n "$GOSTRIPFN" ]; then
	ldflags="$ldflags -stripfn $GOSTRIPFN"
fi

$GOBIN build -tags $GOTARGET -ldflags "$ldflags" -o $name.elf $@

rm -f zisrnames.go

rm -f $name.hex $name-settings.hex $name.bin
case "$GOOUT" in
hex)
	objcopy -O ihex $name.elf $name.hex
	;;
bin)
	objcopy -O binary $name.elf $name.bin
	;;
esac
